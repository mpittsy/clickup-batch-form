<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Batch Video Task - ClickUp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        select, input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .range-inputs span {
            text-align: center;
            color: #666;
            font-weight: 600;
        }

        .preview {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }

        .preview-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .preview-task-name {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .preview-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .preview-detail {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .preview-detail-label {
            color: #666;
        }

        .preview-detail-value {
            font-weight: 600;
            color: #333;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            font-size: 14px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <h1 style="margin: 0;">ðŸŽ¬ Create Batch Video Task</h1>
                <p class="subtitle" style="margin: 5px 0 0 0;">Select options to auto-generate task and subtasks</p>
            </div>
            <button type="button" onclick="clearApiToken()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                Reset API Token
            </button>
        </div>

        <form id="batchTaskForm">
            <div class="form-group">
                <label for="year">Year</label>
                <select id="year" required>
                    <option value="">Select Year</option>
                </select>
            </div>

            <div class="form-group">
                <label for="month">Month</label>
                <select id="month" required>
                    <option value="">Select Month</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            <div class="form-group">
                <label for="client">Client Name</label>
                <select id="client" required>
                    <option value="">Loading clients...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="contentType">Content Type</label>
                <select id="contentType" required>
                    <option value="">Select Type</option>
                    <option value="SF">SF - Short Form</option>
                    <option value="LF">LF - Long Form</option>
                </select>
            </div>

            <div class="form-group">
                <label>Video Range (1-50)</label>
                <div class="range-inputs">
                    <input type="number" id="rangeStart" min="1" max="50" value="1" required>
                    <span>to</span>
                    <input type="number" id="rangeEnd" min="1" max="50" value="1" required>
                </div>
            </div>

            <div class="preview">
                <div class="preview-label">Task Preview</div>
                <div class="preview-task-name" id="previewTaskName">Select options above</div>
                <div class="preview-details">
                    <div class="preview-detail">
                        <span class="preview-detail-label">Number of Videos:</span>
                        <span class="preview-detail-value" id="previewCount">0</span>
                    </div>
                    <div class="preview-detail">
                        <span class="preview-detail-label">Subtasks to create:</span>
                        <span class="preview-detail-value" id="previewSubtasks">None</span>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="resetForm()">Reset</button>
                <button type="submit" class="btn-primary" id="createBtn">
                    Create Task & Subtasks
                </button>
            </div>
        </form>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            CLICKUP_API_TOKEN: null, // Will be set from localStorage or user input
            EDITING_LIST_ID: '901325195633',
            SPACE_ID: '901313145161',
            CUSTOM_FIELD_IDS: {
                CONTENT_MONTH: 'a9395ec9-0aed-43a3-a391-167fd181fd2f',
                NUMBER_OF_VIDEOS: 'df328cb0-a4b5-4069-99cd-b70696ee73a0',
                CONTENT_TYPE: '013674ef-0c86-4006-8611-63d1ddfdcd12'
            }
        };

        // Initialize API token from localStorage or prompt user
        function initializeApiToken() {
            // Check if token exists in localStorage
            let token = localStorage.getItem('clickup_api_token');

            if (!token) {
                // Prompt user for token
                token = prompt(
                    'Welcome! Please enter your ClickUp API token.\n\n' +
                    'To get your token:\n' +
                    '1. Go to ClickUp â†’ Settings â†’ Apps\n' +
                    '2. Click "Generate" under API Token\n' +
                    '3. Copy and paste it here\n\n' +
                    'Your token will be saved securely in this browser.'
                );

                if (!token) {
                    alert('API token is required to use this form. Please refresh and try again.');
                    return false;
                }

                // Validate token format (should start with pk_)
                if (!token.startsWith('pk_')) {
                    alert('Invalid token format. ClickUp API tokens start with "pk_".\n\nPlease refresh and try again.');
                    return false;
                }

                // Save to localStorage
                localStorage.setItem('clickup_api_token', token);
            }

            CONFIG.CLICKUP_API_TOKEN = token;
            return true;
        }

        // Function to clear stored token (for troubleshooting)
        function clearApiToken() {
            localStorage.removeItem('clickup_api_token');
            alert('API token cleared. Please refresh the page to enter a new token.');
        }

        // Initialize year dropdown
        function initYearDropdown() {
            const yearSelect = document.getElementById('year');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            yearSelect.value = currentYear;
        }

        // Fetch clients from ClickUp
        async function loadClients() {
            const clientSelect = document.getElementById('client');

            try {
                // Fetch all folders in the Production & Active Client Monthly space
                const response = await fetch(`https://api.clickup.com/api/v2/space/${CONFIG.SPACE_ID}/folder`, {
                    headers: {
                        'Authorization': CONFIG.CLICKUP_API_TOKEN
                    }
                });

                const data = await response.json();
                const folders = data.folders || [];

                clientSelect.innerHTML = '<option value="">Select Client</option>';

                // Filter for client folders (exclude Sales Pipeline, Onboarding, etc.)
                const clientFolders = folders.filter(f =>
                    !['Sales Pipeline', 'Onboarding Pipeline', 'Production & Active Client Monthly'].includes(f.name)
                );

                // Add "Sample Client" if it exists
                const sampleClient = folders.find(f => f.name === 'Sample Client');
                if (sampleClient) {
                    const option = document.createElement('option');
                    option.value = 'Sample Client';
                    option.textContent = 'Sample Client';
                    clientSelect.appendChild(option);
                }

                // Add other clients alphabetically
                clientFolders
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(folder => {
                        if (folder.name !== 'Sample Client') {
                            const option = document.createElement('option');
                            option.value = folder.name;
                            option.textContent = folder.name;
                            clientSelect.appendChild(option);
                        }
                    });

                // If no clients, allow manual entry
                if (clientFolders.length === 0) {
                    clientSelect.innerHTML = '<option value="">No clients found</option>';
                }

            } catch (error) {
                console.error('Error loading clients:', error);
                clientSelect.innerHTML = '<option value="">Error loading clients</option>';
            }
        }

        // Update preview
        function updatePreview() {
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            const client = document.getElementById('client').value;
            const contentType = document.getElementById('contentType').value;
            const rangeStart = parseInt(document.getElementById('rangeStart').value) || 1;
            const rangeEnd = parseInt(document.getElementById('rangeEnd').value) || 1;

            const previewName = document.getElementById('previewTaskName');
            const previewCount = document.getElementById('previewCount');
            const previewSubtasks = document.getElementById('previewSubtasks');

            if (year && month && client && contentType && rangeStart <= rangeEnd) {
                const yyyymm = year + month;
                const range = rangeStart === rangeEnd
                    ? String(rangeStart).padStart(2, '0')
                    : `${String(rangeStart).padStart(2, '0')}-${String(rangeEnd).padStart(2, '0')}`;

                const taskName = `${yyyymm} ${client} ${contentType} ${range}`;
                const videoCount = rangeEnd - rangeStart + 1;

                previewName.textContent = taskName;
                previewCount.textContent = videoCount;

                // Show sample subtasks
                const samples = [];
                for (let i = rangeStart; i <= Math.min(rangeStart + 2, rangeEnd); i++) {
                    samples.push(`${yyyymm} ${client} ${contentType} ${String(i).padStart(2, '0')}`);
                }
                if (videoCount > 3) {
                    samples.push(`... and ${videoCount - 3} more`);
                }
                previewSubtasks.textContent = samples.join(', ');

            } else {
                previewName.textContent = 'Select options above';
                previewCount.textContent = '0';
                previewSubtasks.textContent = 'None';
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Create task in ClickUp
        async function createBatchTask(event) {
            event.preventDefault();

            const createBtn = document.getElementById('createBtn');
            const originalText = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="loading"></span> Creating...';

            try {
                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const client = document.getElementById('client').value;
                const contentType = document.getElementById('contentType').value;
                const rangeStart = parseInt(document.getElementById('rangeStart').value);
                const rangeEnd = parseInt(document.getElementById('rangeEnd').value);

                const yyyymm = year + month;
                const range = rangeStart === rangeEnd
                    ? String(rangeStart).padStart(2, '0')
                    : `${String(rangeStart).padStart(2, '0')}-${String(rangeEnd).padStart(2, '0')}`;

                const taskName = `${yyyymm} ${client} ${contentType} ${range}`;
                const videoCount = rangeEnd - rangeStart + 1;

                // Get Content Type dropdown index (SF=0, LF=1)
                const contentTypeIndex = contentType === 'SF' ? 0 : 1;

                // Calculate Content Month timestamp (first day of selected month)
                const contentMonthDate = new Date(year, parseInt(month) - 1, 1);
                const contentMonthTimestamp = contentMonthDate.getTime();

                showStatus('Creating batch task in ClickUp...', 'info');

                // Create the task
                const response = await fetch(`https://api.clickup.com/api/v2/list/${CONFIG.EDITING_LIST_ID}/task`, {
                    method: 'POST',
                    headers: {
                        'Authorization': CONFIG.CLICKUP_API_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: taskName,
                        description: `Batch video task: ${videoCount} ${contentType} videos`,
                        status: 'to do'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to create task: ${response.statusText}`);
                }

                const taskData = await response.json();
                const taskId = taskData.id;

                showStatus('Setting custom fields...', 'info');

                // Set custom fields
                await Promise.all([
                    // Set Content Month
                    fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${CONFIG.CUSTOM_FIELD_IDS.CONTENT_MONTH}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': CONFIG.CLICKUP_API_TOKEN,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ value: contentMonthTimestamp })
                    }),
                    // Set Number of Videos
                    fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${CONFIG.CUSTOM_FIELD_IDS.NUMBER_OF_VIDEOS}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': CONFIG.CLICKUP_API_TOKEN,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ value: videoCount })
                    }),
                    // Set Content Type
                    fetch(`https://api.clickup.com/api/v2/task/${taskId}/field/${CONFIG.CUSTOM_FIELD_IDS.CONTENT_TYPE}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': CONFIG.CLICKUP_API_TOKEN,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ value: contentTypeIndex })
                    })
                ]);

                showStatus('Creating subtasks...', 'info');

                // Create subtasks sequentially with proper ordering
                for (let i = rangeStart; i <= rangeEnd; i++) {
                    const videoNumber = String(i).padStart(2, '0');
                    const subtaskName = `${yyyymm} ${client} ${contentType} ${videoNumber}`;

                    // Calculate priority (1 = highest, 4 = lowest)
                    // Using priority 2 for all, but creating sequentially ensures correct order
                    const priority = 2;

                    await fetch(`https://api.clickup.com/api/v2/list/${CONFIG.EDITING_LIST_ID}/task`, {
                        method: 'POST',
                        headers: {
                            'Authorization': CONFIG.CLICKUP_API_TOKEN,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: subtaskName,
                            parent: taskId,
                            status: 'to do',
                            priority: priority
                        })
                    });

                    // Small delay to avoid rate limiting and ensure sequential creation
                    if (i < rangeEnd) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }

                showStatus(`âœ… Success! Created "${taskName}" with ${videoCount} subtasks instantly!`, 'success');

                // Open the task in ClickUp
                setTimeout(() => {
                    window.open(taskData.url, '_blank');
                }, 1500);

                // Reset form after 3 seconds
                setTimeout(() => {
                    resetForm();
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
                showStatus(`âŒ Error: ${error.message}`, 'error');
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('batchTaskForm').reset();
            initYearDropdown();
            updatePreview();
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('createBtn').disabled = false;
            document.getElementById('createBtn').innerHTML = 'Create Task & Subtasks';
        }

        // Event listeners
        document.getElementById('batchTaskForm').addEventListener('submit', createBatchTask);
        ['year', 'month', 'client', 'contentType', 'rangeStart', 'rangeEnd'].forEach(id => {
            document.getElementById(id).addEventListener('change', updatePreview);
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        // Initialize
        window.addEventListener('load', () => {
            // Initialize API token first
            if (!initializeApiToken()) {
                return; // Stop if token initialization failed
            }

            initYearDropdown();
            loadClients();
            updatePreview();

            // Set current month
            const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
            document.getElementById('month').value = currentMonth;
            updatePreview();
        });
    </script>
</body>
</html>
